# MindTouch Î»#
# Copyright (C) 2018 MindTouch, Inc.
# www.mindtouch.com  oss@mindtouch.com
#
# For community documentation and downloads visit mindtouch.com;
# please review the licensing section.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

Module: LambdaSharp
Version: 0.5-WIP
Description: LambdaSharp Runtime
Pragmas:
  - no-runtime-version-check
  - no-lambdasharp-dependencies
  - no-module-registration

Outputs:

  # Exported Values
  - Export: DeadLetterQueueArn
    Description: LambdaSharp Dead Letter Queue
    Value: !Ref DeadLetterQueueArn

  - Export: LoggingStreamArn
    Description: LambdaSharp Logging Stream
    Value: !Ref LoggingStreamArn

  - Export: LoggingStreamRoleArn
    Description: LambdaSharp Logging Stream Role
    Value: !GetAtt LoggingStreamRole.Arn

  - Export: DefaultSecretKeyArn
    Description: LambdaSharp Default Secrets Key
    Value: !Ref DefaultSecretKeyArn

Entries:

  # LambdaSharp Tier Settings
  - Parameter: DeadLetterQueueArn
    Section: LambdaSharp Tier Settings
    Label: Dead Letter Queue (ARN)
    Description: Dead letter queue for functions (leave blank to create a new queue)
    Type: AWS::SQS::Queue
    Default: ""

  - Parameter: LoggingStreamArn
    Section: LambdaSharp Tier Settings
    Label: Logging Stream (ARN)
    Description: Logging kinesis stream for functions (leave blank to create a new stream)
    Type: AWS::Kinesis::Stream
    Default: ""
    Properties:
      RetentionPeriodHours: !Ref LoggingStreamRetentionPeriod
      ShardCount: 1

  - Parameter: LoggingStreamRetentionPeriod
    Section: LambdaSharp Tier Settings
    Label: Retention period (hours)
    Description: How long logging stream entries are kept before they are lost
    Default: 24

  - Parameter: DefaultSecretKeyArn
    Section: LambdaSharp Tier Settings
    Label: Default Secret Key (ARN)
    Description: Default secret key for functions (leave blank to create a new key)
    Type: AWS::KMS::Key
    Default: ""
    Properties:
      Description: Default encryption/decryption key for LambdaSharp modules
      EnableKeyRotation: !Ref DefaultSecretKeyRotationEnabled
      KeyPolicy:
        Version: 2012-10-17
        Id: !Sub "${AWS::StackName}ModuleDefaultSecretKeyPolicy"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"

  - Parameter: DefaultSecretKeyRotationEnabled
    Section: LambdaSharp Tier Settings
    Label: Enable key rotation
    Description: Rotate KMS key automatically every 365 days
    Default: false

  - Resource: LoggingStreamRole
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: CloudWatchLogsPrincipal
            Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub "${AWS::StackName}CloudWatchLogsKinesisPolicy"
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: CloudWatchLogsKinesisPermissions
                Effect: Allow
                Action: kinesis:PutRecord
                Resource: !Ref LoggingStreamArn

  # Resource Definitions
  - Resource: DefaultSecretKeyAlias
    Description: Alias for default secrets key
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${DeploymentPrefix}LambdaSharpDefaultSecretKey"
      TargetKeyId: !Ref DefaultSecretKeyArn
