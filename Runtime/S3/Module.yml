# MindTouch Î»#
# Copyright (C) 2018 MindTouch, Inc.
# www.mindtouch.com  oss@mindtouch.com
#
# For community documentation and downloads visit mindtouch.com;
# please review the licensing section.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

Module: LambdaSharp.S3
Version: 0.5-WIP
Description: LambdaSharp S3 Utility Module
Items:

  - ResourceType: LambdaSharp::S3::Unzip
    Description: Resource for deploying the contents of a zip file to an S3 bucket
    Handler: CustomResourceTopic
    Properties:
      Request:

        - Name: DestinationBucket
          Description: Destination S3 bucket ARN/name where to unzip the zip file to
          Type: String
          Required: true

        - Name: DestinationKeyPrefix
          Description: Destination S3 key prefix for all unzipped files
          Type: String
          Required: true

        - Name: SourceBucket
          Description: Source S3 bucket ARN/name for the zip file
          Type: String
          Required: true

        - Name: SourcePackageKey
          Description: Source S3 key for the zip file
          Type: String
          Required: true

      Response:

        - Name: Url
          Description: Destination S3 URL with destination bucket name and key prefix
          Type: String

  - Resource: DestinationBucketPermissions
    Description: LambdaSharpS3PackageLoader requires read-write access to all S3 buckets
    Type: AWS::S3::Bucket
    Allow: ReadWrite
    Value: !Sub "arn:aws:s3:::${DeploymentPrefixLowercase}*"

  - Resource: SourceBucketPermissions
    Description: LambdaSharpS3PackageLoader requires read-write access to all S3 buckets
    Type: AWS::S3::Bucket
    Allow: ReadOnly
    Value: !Sub "arn:aws:s3:::*"

  - Resource: CustomResourceTopic
    Description: Custom resource topic for deploying packages to S3 buckets
    Type: AWS::SNS::Topic
    Allow: Subscribe

  - Resource: ManifestBucket
    Scope: "*"
    Description: Bucket to store information about uploaded packages
    Type: AWS::S3::Bucket
    Allow: ReadWrite

  - Function: S3Writer
    Description: LambdaSharp S3 Package Loader handler
    Memory: 256
    Timeout: 300
    Sources:
      - Topic: CustomResourceTopic
